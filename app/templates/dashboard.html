{% extends "base.html" %}

{% block content %}
<section class="hero">
  <div>
    <h2>Tableau de bord des sauvegardes</h2>
    <p>Automatisation, alertes et restauration directe des conteneurs.</p>
  </div>
  <div class="hero-badge">
    <span>üîí S√©curit√© maximale activ√©e</span>
  </div>
</section>

{% if force_password_change %}
  <div class="alert warning">Votre mot de passe doit √™tre modifi√© avant d'utiliser toutes les fonctionnalit√©s.</div>
{% endif %}

<section class="grid">
  <div class="panel">
    <h3>Stacks d√©tect√©es</h3>
    <div class="card-list">
      {% for stack_name, stack_containers in stacks.items() %}
        <div class="card">
          <div>
            <h4>{{ stack_name }}</h4>
            <p>{{ stack_containers | length }} conteneur(s)</p>
            <ul>
              {% for container in stack_containers %}
                <li>{{ container.name }}</li>
              {% endfor %}
            </ul>
            {% set last_backup = latest_stack_backups.get(stack_name) %}
            {% if last_backup %}
              <p class="backup-summary">
                Derni√®re sauvegarde : {{ last_backup[4] }}
                <span class="status {{ last_backup[5] }}">{{ last_backup[5] }}</span>
              </p>
            {% else %}
              <p class="backup-summary">Derni√®re sauvegarde : aucune</p>
            {% endif %}
          </div>
          <div class="card-actions">
            <form method="post" action="{{ url_for('backup_stack_route', stack_name=stack_name) }}">
              <button type="submit">Sauvegarder la stack</button>
            </form>
            <details class="history-details">
              <summary>Historique</summary>
              {% set history = stack_backups.get(stack_name, []) %}
              <div class="table compact">
                <div class="table-row header">
                  <span>Type</span>
                  <span>Nom</span>
                  <span>Date</span>
                  <span>Statut</span>
                  <span>Actions</span>
                </div>
                {% for backup in history %}
                  <div class="table-row">
                    <span>{{ backup[1] }}</span>
                    <span>{{ backup[2] }}</span>
                    <span>{{ backup[4] }}</span>
                    <span class="status {{ backup[5] }}">{{ backup[5] }}</span>
                    <span class="actions">
                      <a href="{{ url_for('download_backup', filename=backup[3].split('/')[-1]) }}">T√©l√©charger</a>
                      <form method="post" action="{{ url_for('restore_backup') }}">
                        <input type="hidden" name="backup_id" value="{{ backup[0] }}">
                        <button type="submit">Restaurer</button>
                      </form>
                      <form method="post" action="{{ url_for('delete_backup') }}">
                        <input type="hidden" name="backup_id" value="{{ backup[0] }}">
                        <button type="submit" class="danger">Supprimer</button>
                      </form>
                    </span>
                  </div>
                {% else %}
                  <p>Aucune sauvegarde encore.</p>
                {% endfor %}
              </div>
            </details>
          </div>
        </div>
      {% else %}
        <p>Aucune stack d√©tect√©e.</p>
      {% endfor %}
    </div>
  </div>

  <div class="panel">
    <h3>Conteneurs ind√©pendants</h3>
    <div class="card-list">
      {% for container in containers %}
        <div class="card">
          <div>
            <h4>{{ container.name }}</h4>
            <p>ID: {{ container.short_id }}</p>
            <p>Status: {{ container.status }}</p>
            {% set last_backup = latest_container_backups.get(container.name) %}
            {% if last_backup %}
              <p class="backup-summary">
                Derni√®re sauvegarde : {{ last_backup[4] }}
                <span class="status {{ last_backup[5] }}">{{ last_backup[5] }}</span>
              </p>
            {% else %}
              <p class="backup-summary">Derni√®re sauvegarde : aucune</p>
            {% endif %}
          </div>
          <div class="card-actions">
            <form method="post" action="{{ url_for('backup_container_route', container_id=container.id) }}">
              <button type="submit">Sauvegarder</button>
            </form>
            <details class="history-details">
              <summary>Historique</summary>
              {% set history = container_backups.get(container.name, []) %}
              <div class="table compact">
                <div class="table-row header">
                  <span>Type</span>
                  <span>Nom</span>
                  <span>Date</span>
                  <span>Statut</span>
                  <span>Actions</span>
                </div>
                {% for backup in history %}
                  <div class="table-row">
                    <span>{{ backup[1] }}</span>
                    <span>{{ backup[2] }}</span>
                    <span>{{ backup[4] }}</span>
                    <span class="status {{ backup[5] }}">{{ backup[5] }}</span>
                    <span class="actions">
                      <a href="{{ url_for('download_backup', filename=backup[3].split('/')[-1]) }}">T√©l√©charger</a>
                      <form method="post" action="{{ url_for('restore_backup') }}">
                        <input type="hidden" name="backup_id" value="{{ backup[0] }}">
                        <button type="submit">Restaurer</button>
                      </form>
                      <form method="post" action="{{ url_for('delete_backup') }}">
                        <input type="hidden" name="backup_id" value="{{ backup[0] }}">
                        <button type="submit" class="danger">Supprimer</button>
                      </form>
                    </span>
                  </div>
                {% else %}
                  <p>Aucune sauvegarde encore.</p>
                {% endfor %}
              </div>
            </details>
            {% set schedule = schedules.get(container.name) %}
            {% if schedule %}
              {% set day_labels = namespace(items=[]) %}
              {% for day in week_days %}
                {% if day.value in schedule.days %}
                  {% set _ = day_labels.items.append(day.label) %}
                {% endif %}
              {% endfor %}
              <p class="schedule-summary">
                Planifi√© {{ day_labels.items | join(', ') }} √† {{ schedule.time }} (r√©tention {{ schedule.retention }})
              </p>
            {% else %}
              <p class="schedule-summary">Planification inactive</p>
            {% endif %}
            <form method="post" action="{{ url_for('schedule_container', container_id=container.id) }}" class="schedule-form">
              <div class="weekday-grid">
                {% for day in week_days %}
                  <label class="checkbox">
                    <input type="checkbox" name="days" value="{{ day.value }}" {% if schedule and day.value in schedule.days %}checked{% endif %}>
                    <span>{{ day.label }}</span>
                  </label>
                {% endfor %}
              </div>
              <label>
                Heure de sauvegarde
                <input type="time" name="time" value="{{ schedule.time if schedule else '' }}">
              </label>
              <label>
                R√©tention (sauvegardes)
                <input type="number" name="retention" min="0" value="{{ schedule.retention if schedule else 20 }}">
              </label>
              <div class="schedule-actions">
                <button type="submit" class="primary">Planifier</button>
                <button type="submit" name="disable" value="1" class="ghost">D√©sactiver</button>
              </div>
            </form>
          </div>
        </div>
      {% else %}
        <p>Aucun conteneur ind√©pendant d√©tect√©.</p>
      {% endfor %}
    </div>
  </div>

  
</section>

<section class="panel">
  <h3>Historique des sauvegardes</h3>
  <div class="table">
    <div class="table-row header">
      <span>Type</span>
      <span>Nom</span>
      <span>Date</span>
      <span>Statut</span>
      <span>Actions</span>
    </div>
    {% for backup in backups %}
      <div class="table-row">
        <span>{{ backup[1] }}</span>
        <span>{{ backup[2] }}</span>
        <span>{{ backup[4] }}</span>
        <span class="status {{ backup[5] }}">{{ backup[5] }}</span>
        <span class="actions">
          <a href="{{ url_for('download_backup', filename=backup[3].split('/')[-1]) }}">T√©l√©charger</a>
          <form method="post" action="{{ url_for('restore_backup') }}">
            <input type="hidden" name="backup_id" value="{{ backup[0] }}">
            <button type="submit">Restaurer</button>
          </form>
          <form method="post" action="{{ url_for('delete_backup') }}">
            <input type="hidden" name="backup_id" value="{{ backup[0] }}">
            <button type="submit" class="danger">Supprimer</button>
          </form>
          <form method="post" action="{{ url_for('manual_drive_transfer') }}">
            <input type="hidden" name="backup_id" value="{{ backup[0] }}">
            <button type="submit" class="ghost">Vers Drive</button>
          </form>
        </span>
      </div>
    {% else %}
      <p>Aucune sauvegarde encore.</p>
    {% endfor %}
  </div>
</section>
{% endblock %}
