<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SauveDocker</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="brand">
        <span class="logo">üõ°Ô∏è</span>
        <div>
          <h1>SauveDocker</h1>
          <p>Backup & restauration</p>
        </div>
      </div>
      {% if current_user.is_authenticated %}
      <nav>
        <a href="{{ url_for('dashboard') }}">Tableau de bord</a>
        <a href="{{ url_for('settings') }}">Param√®tres</a>
        <a href="{{ url_for('logs') }}">Logs</a>
        <a href="{{ url_for('setup_mfa') }}">MFA</a>
        <a href="{{ url_for('logout') }}" class="danger">D√©connexion</a>
      </nav>
      {% endif %}
      <div class="footer">
        <p>S√©curit√© maximale activ√©e</p>
      </div>
    </aside>
    <main>
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-group">
            {% for category, message in messages %}
              <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </main>
  </div>
  <div id="task-overlay" class="progress-overlay" aria-hidden="true">
    <div class="progress-card">
      <strong id="task-title">Op√©ration en cours</strong>
      <div class="progress-bar"><span id="task-progress"></span></div>
      <div class="progress-meta">
        <span id="task-message">Initialisation...</span>
        <span id="task-percent">0%</span>
      </div>
      <div id="task-details" class="hint"></div>
      <button type="button" id="task-close" class="ghost">Fermer</button>
    </div>
  </div>
  <script>
    const overlay = document.getElementById("task-overlay");
    const titleEl = document.getElementById("task-title");
    const messageEl = document.getElementById("task-message");
    const percentEl = document.getElementById("task-percent");
    const progressEl = document.getElementById("task-progress");
    const detailsEl = document.getElementById("task-details");
    const closeBtn = document.getElementById("task-close");

    const showOverlay = () => {
      overlay.classList.add("active");
      overlay.setAttribute("aria-hidden", "false");
    };

    const hideOverlay = () => {
      overlay.classList.remove("active");
      overlay.setAttribute("aria-hidden", "true");
    };

    const updateOverlay = (data) => {
      const progress = Math.min(100, Math.max(0, data.progress || 0));
      titleEl.textContent = data.target_name
        ? `${data.target_type || "T√¢che"} : ${data.target_name}`
        : "Op√©ration en cours";
      messageEl.textContent = data.message || "Traitement en cours";
      percentEl.textContent = `${progress}%`;
      progressEl.style.width = `${progress}%`;
      detailsEl.textContent = data.details || "";
    };

    const pollTask = async (taskId) => {
      try {
        const response = await fetch(`/tasks/${taskId}`);
        const data = await response.json();
        updateOverlay(data);
        if (data.status === "success" || data.status === "failed") {
          closeBtn.textContent = "Actualiser";
          closeBtn.dataset.refresh = "true";
          return;
        }
      } catch (error) {
        updateOverlay({ message: "Erreur de suivi", details: error.toString(), progress: 100 });
        closeBtn.textContent = "Fermer";
        return;
      }
      setTimeout(() => pollTask(taskId), 1500);
    };

    closeBtn.addEventListener("click", () => {
      if (closeBtn.dataset.refresh === "true") {
        window.location.reload();
      } else {
        hideOverlay();
      }
    });

    document.querySelectorAll("form.async-task").forEach((form) => {
      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        closeBtn.dataset.refresh = "false";
        closeBtn.textContent = "Fermer";
        showOverlay();
        updateOverlay({ message: "D√©marrage de la t√¢che", progress: 0, details: "" });
        try {
          const response = await fetch(form.action, {
            method: form.method || "POST",
            body: new FormData(form),
          });
          const data = await response.json();
          if (!data.task_id) {
            updateOverlay({ message: "Erreur", details: data.error || "Impossible de d√©marrer la t√¢che", progress: 100 });
            return;
          }
          pollTask(data.task_id);
        } catch (error) {
          updateOverlay({ message: "Erreur", details: error.toString(), progress: 100 });
        }
      });
    });
  </script>
</body>
</html>
